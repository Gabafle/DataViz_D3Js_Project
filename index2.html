<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Empreinte Carbone Interactive - France & Monde</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson@3"></script>
<style>
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f5f5; color:#333; margin:0; padding:0; }
    h1,h2 { text-align:center; margin:20px 0; }
    .chart-container { width:95%; max-width:1100px; margin:40px auto; position:relative; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    svg { display:block; margin:auto; overflow: visible; }
    
    /* Tooltip */
    .tooltip { position:absolute; background:rgba(0,0,0,0.85); color:#fff; padding:10px; border-radius:6px; pointer-events:none; font-size:13px; opacity:0; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: opacity 0.2s; max-width: 250px; }
    .tooltip-header { font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 3px; }

    /* Switch Style */
    .switch-wrapper { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 30px; font-weight: 600; font-size: 14px; color: #666; }
    .switch-label.active { color: #2c3e50; }
    .slider { position:relative; width:50px; height:26px; background:#ccc; border-radius:20px; cursor:pointer; transition: background 0.3s; }
    .slider.active-total { background: #4CAF50; }
    .slider.active-capita { background: #2196F3; }
    .slider-circle { position:absolute; width:20px; height:20px; background:#fff; border-radius:50%; top:3px; left:3px; transition:all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    .map-header { margin-bottom: 30px; }
    .map-subtitle { text-align: center; font-size: 14px; color: #666; margin-top: 5px; }

    /* Info Bubble */
    .info-bubble { position: absolute; left: 20px; top: 150px; width: 220px; background: #e3f2fd; border: 2px solid #2196f3; padding: 15px; border-radius: 15px; font-size: 13px; line-height: 1.4; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .info-bubble b { color: #1976d2; display: block; margin-bottom: 5px; }
    
    #backBtn { display: none; position: absolute; top: 110px; left: 50%; transform: translateX(-50%); padding: 8px 16px; background: #2ca02c; color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold; z-index: 5; }

    /* Legends */
    .legend { display:flex; justify-content:center; gap:20px; margin-top:30px; flex-wrap:wrap; padding: 15px; border-top: 1px solid #eee; }
    .legend-item { display:flex; align-items:center; gap:8px; font-size:12px; font-weight: 500; min-width: 150px; }
    .legend-item span { width:14px; height:14px; display:inline-block; border-radius:3px; }
    
    #yearSelector { display:block; margin:10px auto 25px; font-size:16px; padding:6px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    .labelText { font-size:11px; fill:#333; font-weight:700; pointer-events: none; }
    .polyline { fill: none; stroke: #999; stroke-width: 1px; opacity: 0.6; pointer-events: none; }

    /* Cards */
    .info-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 2px solid #f0f0f0; }
    .info-card { background: #fafafa; padding: 15px; border-radius: 8px; border-left: 5px solid #ccc; font-size: 13px; }
    .info-card h4 { margin-top: 0; margin-bottom: 8px; font-size: 14px; }
    
    /* Map & Interactivity */
    .clickable { cursor: pointer !important; filter: brightness(1.2); stroke: #000 !important; stroke-width: 1px !important; }
    .country { stroke: #fff; stroke-width: 0.5px; transition: opacity 0.2s; }
    .country:hover { opacity: 0.8; stroke: #333; stroke-width: 1px; }
    .map-legend-container { display: flex; flex-direction: column; align-items: center; margin-top: 20px; padding-bottom: 10px; }
    .map-legend-bar { width: 300px; height: 15px; border-radius: 4px; }
    .map-legend-labels { width: 300px; display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px; }

    /* NOUVEAUX STYLES */
    .area-diff { fill-opacity: 0.15; }
    .axis-label { font-size: 12px; fill: #666; font-style: italic; }
    .grid-line { stroke: #e0e0e0; stroke-dasharray: 4; }
    
    /* Style specifique au nouveau bar chart */
    .bar { transition: fill-opacity 0.2s; }
    .bar:hover { fill-opacity: 0.8; }
</style>
</head>
<body>

<h1>Analyse de l'Empreinte Carbone (1990-2024) en France</h1>

<div class="chart-container">
  <h2 id="main-title">Empreinte carbone par personne (t CO2 éq) en France depuis 1990</h2>
  <div class="switch-wrapper">
    <span id="label-capita" class="switch-label active">Par personne</span>
    <div class="slider active-capita" id="modeSlider">
      <div class="slider-circle" id="sliderCircle"></div>
    </div>
    <span id="label-total" class="switch-label">Empreinte totale</span>
  </div>
  <svg id="main-chart" width="900" height="400"></svg>
</div>

<div class="chart-container">
    <h2 style="color:#2c3e50;">Composition de l'Empreinte : La part des Importations</h2>
    <div class="map-subtitle">
        Visualisation de ce qui est émis sur le sol français (Bleu) vs ce qui est importé (Rouge).<br>
        On voit clairement que si les émissions locales baissent, les importations stagnent ou augmentent.
    </div>
    <svg id="composition-chart" width="950" height="450"></svg>
    <div class="legend" id="composition-legend"></div>
</div>

<div class="chart-container">
    <h2 style="color:#d32f2f;">Le "Gap" Carbone : Production vs Consommation</h2>
    <div class="map-subtitle">Comparaison entre les émissions sur le sol français et l'empreinte réelle (incluant importations).<br>La zone rouge représente le "déficit" carbone (Importations nettes).</div>
    <svg id="gap-chart" width="950" height="450"></svg>
    <div class="legend" id="gap-legend"></div>
</div>

<div class="chart-container">
    <h2 style="color:#1976d2;">Qui émet quoi ? (Ménages vs Entreprises/État)</h2>
    <div class="map-subtitle">Évolution de la part de l'empreinte carbone totale (en Milliers de tonnes CO2 éq)</div>
    <svg id="stack-chart" width="950" height="450"></svg>
    <div class="legend" id="stack-legend"></div>
</div>

<div class="chart-container">
    <div class="map-header">
        <h2>COMPARAISON INTERNATIONALE - 2022 - Émissions par personne en t CO2 éq</h2>
        <div class="map-subtitle"></div>
    </div>
    <svg id="world-map" width="900" height="500"></svg>
    <div class="map-legend-container">
        <div id="map-gradient" class="map-legend-bar"></div>
        <div class="map-legend-labels">
            <span>Moins polluant (Vert)</span>
            <span>Plus polluant (Rouge)</span>
        </div>
    </div>
</div>

<div class="chart-container">
  <h2 id="pie-title">Détail des émissions sur l'empreinte carbone totale</h2>
  <div id="infoBubble" class="info-bubble">
      <b>Interactivité</b>
      Sélectionnez une année. Les données "Importations" sont estimées par la différence entre l'Empreinte et l'Émission Territoriale.
  </div>
  <select id="yearSelector"></select>
  <button id="backBtn">← Retour</button>
  <svg id="pie" width="950" height="500"></svg>
  <div class="legend" id="pie-legend"></div>
</div>

<div class="chart-container">
    <h2>Quelles branches d'activité ont émis les GES ? (2022)</h2>
    <div class="map-subtitle">GES = Gaz (dioxyde de carbone, méthane, ozone…) présents dans l'atmosphère, qui absorbent le rayonnement infrarouge et contribuent à l'effet de serre.</div>
    <svg id="sector-pie" width="950" height="500"></svg>
    <div class="legend" id="sector-legend"></div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
const tooltip = d3.select("#tooltip");

// --- CHARGEMENT DES DONNÉES ---
Promise.all([
    // Chargement avec les nouvelles colonnes spécifiées
    d3.dsv(";", "./source/Emissions&empreinteGESFrancedepuis1990.csv", d => {
        // Nettoyage des nombres (remplace virgule par point)
        const parse = (val) => val ? parseFloat(val.replace(',', '.')) : 0;
        
        return {
            annee: +d.annee,
            // Nouvelles données précises
            emissions_territoire: parse(d.emissions_totales_territoriales),
            emissions_menages: parse(d.emissions_menages_territoriales),
            emissions_hors_menages: parse(d.emissions_hors_menages_territoriales),
            empreinte_totale: parse(d.empreinte_totale),
            empreinte_menages: parse(d.empreinte_menages),
            empreinte_hors_menages: parse(d.empreinte_hors_menages),
            
            // Données par habitant
            emissions_hab: parse(d.emissions_totales_par_habitant),
            empreinte_hab: parse(d.empreinte_totale_par_habitant)
        };
    }),
    d3.dsv(";", "./source/ComparaisonInternationnalDempreinteCarbonne2022.csv", d => ({
        pays: d.pays,
        valeur: parseFloat(d["2022"].replace(',', '.'))
    })),
    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
    d3.dsv(";", "./source/RepartitionGESFrance2023.csv", d => {
        const keys = Object.keys(d);
        return { name: d[keys[0]], value: parseInt(d[keys[1]]) };
    })
]).then(([dataCSV, dataMap, world, sectorData]) => {

    // ---------------------------------------------------------
    // 1. GRAPHIQUE LINÉAIRE (Existant)
    // ---------------------------------------------------------
    const svgLine = d3.select("#main-chart");
    const wL = +svgLine.attr("width") - 100, hL = +svgLine.attr("height") - 80;
    const gL = svgLine.append("g").attr("transform","translate(70,40)");
    
    const x = d3.scaleLinear().domain(d3.extent(dataCSV, d=>d.annee)).range([0,wL]);
    const yScales = {
        perCapita: d3.scaleLinear().domain([0, 15]).range([hL,0]), 
        total: d3.scaleLinear().domain([0, 900000]).range([hL,0]) 
    };

    let mode = "perCapita"; 
    
    // Axes
    const xAxis = gL.append("g").attr("transform",`translate(0,${hL})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
    const yAxis = gL.append("g");

    // Ligne et points
    const lineGenerator = d3.line().curve(d3.curveMonotoneX);
    const pathLine = gL.append("path").attr("fill","none").attr("stroke-width",3);
    
    function updateLine() {
        const dataKey = mode === "perCapita" ? "empreinte_hab" : "empreinte_totale";
        const color = mode === "perCapita" ? "#2196F3" : "#4CAF50";
        
        yAxis.transition().duration(800).call(d3.axisLeft(yScales[mode]));
        
        lineGenerator.x(d => x(d.annee)).y(d => yScales[mode](d[dataKey]));
        
        pathLine.datum(dataCSV)
            .transition().duration(800)
            .attr("d", lineGenerator)
            .attr("stroke", color);

        const circles = gL.selectAll(".dot").data(dataCSV);
        circles.enter().append("circle").attr("class", "dot")
            .attr("r", 5)
            .merge(circles)
            .transition().duration(800)
            .attr("cx", d => x(d.annee))
            .attr("cy", d => yScales[mode](d[dataKey]))
            .attr("fill", mode === "perCapita" ? "#FF9800" : "#E91E63");
            
        circles.on("mouseover", (e, d) => {
            tooltip.style("opacity", 1)
                   .html(`<div class="tooltip-header">${d.annee}</div>Val: ${d[dataKey].toLocaleString()} ${mode==="perCapita"?"t/hab":"kt CO2"}`)
                   .style("left", (e.pageX+10)+"px").style("top", (e.pageY-20)+"px");
        }).on("mouseout", () => tooltip.style("opacity", 0));
    }
    updateLine();

    // Gestion du switch
    d3.select("#modeSlider").on("click", function(){
        mode = mode === "perCapita" ? "total" : "perCapita";
        const isCapita = mode === "perCapita";
        d3.select("#sliderCircle").style("left", isCapita ? "3px" : "27px");
        d3.select("#modeSlider").classed("active-capita", isCapita).classed("active-total", !isCapita);
        d3.select("#label-capita").classed("active", isCapita);
        d3.select("#label-total").classed("active", !isCapita);
        updateLine();
    });

    // ---------------------------------------------------------
    // 2. NOUVEAU : STACKED BAR CHART (COMPOSITION IMPORT/LOCAL)
    // ---------------------------------------------------------
    // C'est le graphique ajouté demandé pour visualiser la composition
    const svgComp = d3.select("#composition-chart");
    const marginComp = {top: 40, right: 150, bottom: 40, left: 70};
    const wComp = +svgComp.attr("width") - marginComp.left - marginComp.right;
    const hComp = +svgComp.attr("height") - marginComp.top - marginComp.bottom;
    const gComp = svgComp.append("g").attr("transform", `translate(${marginComp.left},${marginComp.top})`);

    // Préparation des données pour le stack
    // On calcule les imports = Empreinte - Territoire (en gérant les petits écarts)
    const dataStackBar = dataCSV.map(d => ({
        annee: d.annee,
        local: d.emissions_territoire,
        imported: Math.max(0, d.empreinte_totale - d.emissions_territoire)
    }));

    const subgroups = ["local", "imported"];
    const groups = dataStackBar.map(d => d.annee);

    const xComp = d3.scaleBand().domain(groups).range([0, wComp]).padding(0.2);
    const yComp = d3.scaleLinear().domain([0, d3.max(dataCSV, d => d.empreinte_totale) * 1.1]).range([hComp, 0]);
    const colorComp = d3.scaleOrdinal().domain(subgroups).range(['#3498db', '#e74c3c']); // Bleu pour local, Rouge pour import

    // Axes
    gComp.append("g").attr("transform", `translate(0,${hComp})`).call(d3.axisBottom(xComp).tickValues(xComp.domain().filter((d,i) => !(i%2)))); // Une année sur 2
    gComp.append("g").call(d3.axisLeft(yComp));

    // Stacking
    const stackedData = d3.stack().keys(subgroups)(dataStackBar);

    gComp.append("g")
        .selectAll("g")
        .data(stackedData)
        .join("g")
        .attr("fill", d => colorComp(d.key))
        .selectAll("rect")
        .data(d => d)
        .join("rect")
        .attr("class", "bar")
        .attr("x", d => xComp(d.data.annee))
        .attr("y", d => yComp(d[1]))
        .attr("height", d => yComp(d[0]) - yComp(d[1]))
        .attr("width", xComp.bandwidth())
        .on("mouseover", function(event, d) {
            const subgroupName = d3.select(this.parentNode).datum().key;
            const subLabel = subgroupName === "local" ? "Émissions en France" : "Importations";
            const val = d[1] - d[0];
            const total = d.data.local + d.data.imported;
            const pct = ((val/total)*100).toFixed(1);
            
            tooltip.style("opacity", 1)
                   .html(`<div class="tooltip-header">Année ${d.data.annee}</div>
                          <b>${subLabel}</b><br>
                          Volume: ${Math.round(val).toLocaleString()} kt<br>
                          Part: ${pct}% de l'empreinte`)
                   .style("left", (event.pageX+10)+"px").style("top", (event.pageY-20)+"px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

    // Légende Composition
    const legendComp = d3.select("#composition-legend");
    [{l:"Émissions Territoriales (France)", c:"#3498db"}, {l:"Importations", c:"#e74c3c"}].forEach(item => {
        const div = legendComp.append("div").attr("class", "legend-item");
        div.append("span").style("background", item.c);
        div.append("div").text(item.l);
    });


    // ---------------------------------------------------------
    // 3. LE GAP (TERRITOIRE vs EMPREINTE) - Existant
    // ---------------------------------------------------------
    const svgGap = d3.select("#gap-chart");
    const marginGap = {top: 40, right: 150, bottom: 40, left: 70};
    const wGap = +svgGap.attr("width") - marginGap.left - marginGap.right;
    const hGap = +svgGap.attr("height") - marginGap.top - marginGap.bottom;
    const gGap = svgGap.append("g").attr("transform", `translate(${marginGap.left},${marginGap.top})`);

    // Echelles
    const xGap = d3.scaleLinear().domain(d3.extent(dataCSV, d=>d.annee)).range([0, wGap]);
    const yGap = d3.scaleLinear()
        .domain([0, d3.max(dataCSV, d => Math.max(d.emissions_territoire, d.empreinte_totale)) * 1.1])
        .range([hGap, 0]);

    // Axes
    gGap.append("g").attr("transform", `translate(0,${hGap})`).call(d3.axisBottom(xGap).tickFormat(d3.format("d")));
    gGap.append("g").call(d3.axisLeft(yGap));

    // Zone de différence (Le Gap)
    const areaGap = d3.area()
        .x(d => xGap(d.annee))
        .y0(d => yGap(d.emissions_territoire)) 
        .y1(d => yGap(d.empreinte_totale))     
        .curve(d3.curveMonotoneX);

    gGap.append("path")
        .datum(dataCSV)
        .attr("fill", "#e57373")
        .attr("fill-opacity", 0.3)
        .attr("d", areaGap);

    // Lignes
    const lineTerritoire = d3.line().x(d=>xGap(d.annee)).y(d=>yGap(d.emissions_territoire)).curve(d3.curveMonotoneX);
    const lineEmpreinte = d3.line().x(d=>xGap(d.annee)).y(d=>yGap(d.empreinte_totale)).curve(d3.curveMonotoneX);

    gGap.append("path").datum(dataCSV).attr("fill","none").attr("stroke","#43a047").attr("stroke-width",3).attr("d", lineTerritoire);
    gGap.append("path").datum(dataCSV).attr("fill","none").attr("stroke","#d32f2f").attr("stroke-width",3).attr("stroke-dasharray", "5,5").attr("d", lineEmpreinte);

    // Légende interactive Gap
    const legendDataGap = [
        {name: "Empreinte Totale (Consommation)", color: "#d32f2f", dashed: true},
        {name: "Émissions Territoriales (Production)", color: "#43a047", dashed: false},
        {name: "Déficit (Importations nettes)", color: "#e57373", rect: true}
    ];
    
    const legendGap = d3.select("#gap-legend");
    legendDataGap.forEach(d => {
        const item = legendGap.append("div").attr("class", "legend-item");
        item.append("span").style("background", d.rect ? d.color : "transparent")
            .style("border-bottom", d.rect ? "none" : `3px ${d.dashed ? 'dashed' : 'solid'} ${d.color}`)
            .style("height", d.rect ? "14px" : "0px").style("margin-bottom", d.rect ? "0" : "7px");
        item.append("div").text(d.name);
    });

    // Interaction Hover Gap
    const hoverLine = gGap.append("line").attr("stroke", "#333").attr("stroke-dasharray", "2,2").style("opacity", 0);
    
    svgGap.on("mousemove", function(event) {
        const [mx] = d3.pointer(event, gGap.node());
        const year = Math.round(xGap.invert(mx));
        const d = dataCSV.find(e => e.annee === year);
        
        if (d) {
            hoverLine.attr("x1", xGap(year)).attr("x2", xGap(year)).attr("y1", 0).attr("y2", hGap).style("opacity", 1);
            const gapVal = d.empreinte_totale - d.emissions_territoire;
            
            tooltip.style("opacity", 1)
                .html(`
                    <div class="tooltip-header">Année ${d.annee}</div>
                    <span style="color:#d32f2f">●</span> Empreinte: ${d.empreinte_totale.toLocaleString()} kt<br>
                    <span style="color:#43a047">●</span> Territoire: ${d.emissions_territoire.toLocaleString()} kt<br>
                    <b>Différence: +${Math.round(gapVal).toLocaleString()} kt</b>
                `)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 20) + "px");
        }
    }).on("mouseout", () => {
        tooltip.style("opacity", 0);
        hoverLine.style("opacity", 0);
    });


    // ---------------------------------------------------------
    // 4. STACKED AREA (MÉNAGES vs HORS MÉNAGES) - Existant
    // ---------------------------------------------------------
    const svgStack = d3.select("#stack-chart");
    const marginStack = {top: 20, right: 20, bottom: 40, left: 70};
    const wStack = +svgStack.attr("width") - marginStack.left - marginStack.right;
    const hStack = +svgStack.attr("height") - marginStack.top - marginStack.bottom;
    const gStack = svgStack.append("g").attr("transform", `translate(${marginStack.left},${marginStack.top})`);

    const stack = d3.stack().keys(["empreinte_menages", "empreinte_hors_menages"]);
    const series = stack(dataCSV);
    const colorStack = d3.scaleOrdinal().domain(["empreinte_menages", "empreinte_hors_menages"]).range(["#ff9800", "#1976d2"]); // Orange & Bleu

    const xStack = d3.scaleLinear().domain(d3.extent(dataCSV, d=>d.annee)).range([0, wStack]);
    const yStack = d3.scaleLinear().domain([0, d3.max(dataCSV, d => d.empreinte_totale) * 1.1]).range([hStack, 0]);

    // Area Generator
    const areaStack = d3.area()
        .x(d => xStack(d.data.annee))
        .y0(d => yStack(d[0]))
        .y1(d => yStack(d[1]))
        .curve(d3.curveMonotoneX);

    gStack.selectAll("path")
        .data(series)
        .join("path")
        .attr("fill", d => colorStack(d.key))
        .attr("d", areaStack)
        .attr("stroke", "#fff")
        .attr("stroke-width", 0.5)
        .on("mousemove", function(event, d) {
             const [mx] = d3.pointer(event, gStack.node());
             const year = Math.round(xStack.invert(mx));
             const row = dataCSV.find(e => e.annee === year);
             if(row) {
                 const keyName = d.key === "empreinte_menages" ? "Ménages" : "Entreprises & État";
                 const val = row[d.key];
                 const pct = ((val / row.empreinte_totale) * 100).toFixed(1);
                 tooltip.style("opacity", 1)
                    .html(`<b>${keyName} (${year})</b><br>${val.toLocaleString()} kt<br>${pct}% du total`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");
             }
             d3.select(this).style("opacity", 0.9);
        })
        .on("mouseout", function() {
            tooltip.style("opacity", 0);
            d3.select(this).style("opacity", 1);
        });

    gStack.append("g").attr("transform", `translate(0,${hStack})`).call(d3.axisBottom(xStack).tickFormat(d3.format("d")));
    gStack.append("g").call(d3.axisLeft(yStack));

    // Légende Stack
    const legendStack = d3.select("#stack-legend");
    [{label:"Ménages (Direct)", color:"#ff9800"}, {label:"Hors-Ménages (Éco/Indus/Admin)", color:"#1976d2"}].forEach(d => {
        const item = legendStack.append("div").attr("class", "legend-item");
        item.append("span").style("background", d.color);
        item.append("div").text(d.label);
    });


    // ---------------------------------------------------------
    // 5. CARTE MONDE (Existant)
    // ---------------------------------------------------------
    const svgMap = d3.select("#world-map");
    const projection = d3.geoMercator().scale(130).translate([450, 350]);
    const pathGenerator = d3.geoPath().projection(projection);
    const colorScaleMap = d3.scaleSequential(d3.interpolateRdYlGn).domain([d3.max(dataMap, d => d.valeur), 0]);
    d3.select("#map-gradient").style("background", `linear-gradient(to right, ${d3.interpolateRdYlGn(1)}, ${d3.interpolateRdYlGn(0)})`);
    
    const countries = topojson.feature(world, world.objects.countries).features;
    const dataMapDict = {};
    dataMap.forEach(d => { dataMapDict[d.pays] = d.valeur; });
    const nameFixes = { "United States of America": "USA", "Saudi Arabia": "Arabie saoudite", "Germany": "Allemagne", "Russia": "Russie", "China": "Chine", "France": "France", "Turkey": "Turquie" };

    svgMap.append("g").selectAll("path").data(countries).enter().append("path")
        .attr("class", "country")
        .attr("d", pathGenerator)
        .attr("fill", d => {
            const name = nameFixes[d.properties.name] || d.properties.name;
            const val = dataMapDict[name];
            return val ? colorScaleMap(val) : "#eee";
        })
        .on("mouseover", (event, d) => {
            const name = nameFixes[d.properties.name] || d.properties.name;
            const val = dataMapDict[name];
            tooltip.style("opacity", 1).html(`<b>${name}</b><br>${val ? val + " t CO2 éq/pers" : "N/A"}`)
                    .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 20) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));


    // ---------------------------------------------------------
    // 6. CAMEMBERT HISTORIQUE (Existant)
    // ---------------------------------------------------------
    const svgPie = d3.select("#pie");
    const wP = +svgPie.attr("width"), hP = +svgPie.attr("height");
    const radius = 140;
    const gPie = svgPie.append("g").attr("transform", `translate(${wP/2},${hP/2})`);
    const pie = d3.pie().value(d => d.value).sort(null).padAngle(0.02);
    const arc = d3.arc().innerRadius(radius * 0.4).outerRadius(radius);
    const outerArc = d3.arc().innerRadius(radius * 1.1).outerRadius(radius * 1.1);

    const yearSelector = d3.select("#yearSelector");
    dataCSV.forEach(d => yearSelector.append("option").attr("value", d.annee).text(d.annee));
    let currentYear = dataCSV[0].annee;

    function getProxiedPieData(year) {
        const row = dataCSV.find(d => d.annee === +year);
        // Calcul des imports nets
        const importsNettes = Math.max(0, row.empreinte_totale - row.emissions_territoire);
        return [
            { name: "Direct (Ménages)", value: row.emissions_menages, color: "#1f77b4" },
            { name: "Production (Entr/Etat)", value: row.emissions_hors_menages, color: "#ff7f0e" },
            { name: "Importations (Est.)", value: importsNettes, color: "#2ca02c" }
        ];
    }

    function drawPie(data) {
        const pieData = pie(data);
        const paths = gPie.selectAll(".pie-slice").data(pieData, d => d.data.name);
        
        paths.exit().remove();
        paths.enter().append("path").attr("class", "pie-slice")
            .merge(paths).transition().duration(750)
            .attr("d", arc).attr("fill", d => d.data.color);

        // Labels
        const texts = gPie.selectAll(".label-pie").data(pieData);
        texts.exit().remove();
        texts.enter().append("text").attr("class", "labelText label-pie").merge(texts)
            .transition().duration(750)
            .attr("transform", d => {
                const pos = outerArc.centroid(d);
                pos[0] = radius * 1.25 * ( (d.startAngle + d.endAngle)/2 < Math.PI ? 1 : -1);
                return `translate(${pos})`;
            })
            .style("text-anchor", d => ( (d.startAngle + d.endAngle)/2 < Math.PI ? "start" : "end"))
            .text(d => `${d.data.name} : ${Math.round(d.data.value)} kt`);
        
        // Polylines
        const polylines = gPie.selectAll(".polyline-hist").data(pieData);
        polylines.exit().remove();
        polylines.enter().append("polyline").attr("class", "polyline polyline-hist").merge(polylines)
            .transition().duration(750)
            .attr("points", d => {
                const posA = arc.centroid(d), posB = outerArc.centroid(d), posC = outerArc.centroid(d);
                posC[0] = radius * 1.18 * ((d.startAngle + d.endAngle)/2 < Math.PI ? 1 : -1);
                return [posA, posB, posC];
            });

        // Légende Pie
        const legend = d3.select("#pie-legend");
        legend.selectAll("*").remove();
        data.forEach(d => {
            const item = legend.append("div").attr("class", "legend-item");
            item.append("span").style("background", d.color);
            item.append("div").text(d.name);
        });
    }

    drawPie(getProxiedPieData(currentYear));
    yearSelector.on("change", function() { currentYear = +this.value; drawPie(getProxiedPieData(currentYear)); });
    
    // Note : Le bouton retour et l'interaction click ont été désactivés car les données "Détail Import" ne sont pas dans le nouveau CSV.
    d3.select("#backBtn").style("display", "none");
    d3.select("#infoBubble").style("opacity", "0");


    // ---------------------------------------------------------
    // 7. CAMEMBERT SECTORIEL (2022) - Existant
    // ---------------------------------------------------------
    const svgSect = d3.select("#sector-pie");
    const radiusS = 160;
    const gSect = svgSect.append("g").attr("transform", `translate(${wP/2},${hP/2})`);
    const colorSect = d3.scaleOrdinal(d3.schemeTableau10);
    const pieS = d3.pie().value(d => d.value).sort(null).padAngle(0.02);
    const arcS = d3.arc().innerRadius(radiusS * 0.5).outerRadius(radiusS);
    const outerArcS = d3.arc().innerRadius(radiusS * 1.2).outerRadius(radiusS * 1.2);
    const pieDataS = pieS(sectorData);

    gSect.selectAll("path").data(pieDataS).enter().append("path")
        .attr("d", arcS).attr("fill", (d, i) => colorSect(i))
        .attr("stroke", "white").style("stroke-width", "2px")
        .on("mouseover", function(e, d) {
            d3.select(this).transition().duration(200).attr("d", d3.arc().innerRadius(radiusS * 0.5).outerRadius(radiusS + 10));
            tooltip.style("opacity", 1).html(`<b>${d.data.name}</b> : ${d.data.value}%`).style("left", (e.pageX+10)+"px").style("top", (e.pageY-20)+"px");
        })
        .on("mouseout", function() {
            d3.select(this).transition().duration(200).attr("d", arcS);
            tooltip.style("opacity", 0);
        });
    
    // Labels Sectoriel
    gSect.selectAll("polyline").data(pieDataS).enter().append("polyline").attr("class", "polyline")
        .attr("points", d => {
            const posA = arcS.centroid(d), posB = outerArcS.centroid(d), posC = outerArcS.centroid(d);
            const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
            posC[0] = radiusS * 1.3 * (midangle < Math.PI ? 1 : -1);
            return [posA, posB, posC];
        });

    gSect.selectAll("text").data(pieDataS).enter().append("text").attr("class", "labelText")
        .attr("transform", d => {
            const pos = outerArcS.centroid(d);
            const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
            pos[0] = radiusS * 1.35 * (midangle < Math.PI ? 1 : -1);
            return `translate(${pos})`;
        })
        .style("text-anchor", d => (d.startAngle + (d.endAngle - d.startAngle) / 2 < Math.PI ? "start" : "end"))
        .text(d => `${d.data.value}%`);

    const sectLegend = d3.select("#sector-legend");
    sectorData.forEach((d, i) => {
        const item = sectLegend.append("div").attr("class", "legend-item");
        item.append("span").style("background", colorSect(i));
        item.append("div").text(d.data ? d.data.name : d.name.replace(';', ' - '));
    });

});
</script>
</body>
</html>